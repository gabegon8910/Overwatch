# Overwatch - Server Management Platform
# https://github.com/gabegon8910/Overwatch
#
# Quick start:
#   curl -fsSL https://raw.githubusercontent.com/gabegon8910/Overwatch/main/install.sh | bash
#
# Manual start:
#   cp .env.example .env   # then edit .env
#   docker compose up -d
#
# Upgrade:
#   VERSION=2.2.3 docker compose pull && docker compose up -d
#
# Rollback:
#   VERSION=2.2.2 docker compose up -d

services:
  postgres:
    image: postgres:15-alpine
    container_name: ssm-postgres
    restart: unless-stopped
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-ssm_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-ssm_password}
      POSTGRES_DB: ${POSTGRES_DB:-ssm_db}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-ssm_user} -d ${POSTGRES_DB:-ssm_db}"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    container_name: ssm-redis
    restart: unless-stopped
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  backend:
    image: ghcr.io/${GITHUB_OWNER:-gabegon8910}/server-management-backend:${VERSION:-latest}
    container_name: ssm-backend
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=100M
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-ssm_user}:${POSTGRES_PASSWORD:-ssm_password}@postgres:5432/${POSTGRES_DB:-ssm_db}
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-change-this-32-byte-key-here!!}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost}
      - LICENSE_SERVER_URL=${LICENSE_SERVER_URL:-https://ow-license1.byteforce.us/v1}
      - LICENSE_KEY=${LICENSE_KEY:-}
    volumes:
      - backend_backups:/app/backups
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  celery-worker:
    image: ghcr.io/${GITHUB_OWNER:-gabegon8910}/server-management-backend:${VERSION:-latest}
    container_name: ssm-celery-worker
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=100M
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-ssm_user}:${POSTGRES_PASSWORD:-ssm_password}@postgres:5432/${POSTGRES_DB:-ssm_db}
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-change-this-32-byte-key-here!!}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost}
      - LICENSE_SERVER_URL=${LICENSE_SERVER_URL:-https://ow-license1.byteforce.us/v1}
      - LICENSE_KEY=${LICENSE_KEY:-}
    volumes:
      - backend_backups:/app/backups
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: celery -A app.tasks.celery_app worker --loglevel=info

  celery-beat:
    image: ghcr.io/${GITHUB_OWNER:-gabegon8910}/server-management-backend:${VERSION:-latest}
    container_name: ssm-celery-beat
    restart: unless-stopped
    read_only: true
    tmpfs:
      - /tmp:size=100M
    environment:
      - DATABASE_URL=postgresql://${POSTGRES_USER:-ssm_user}:${POSTGRES_PASSWORD:-ssm_password}@postgres:5432/${POSTGRES_DB:-ssm_db}
      - REDIS_URL=redis://redis:6379/0
      - SECRET_KEY=${SECRET_KEY:-change-this-secret-key-in-production}
      - ENCRYPTION_KEY=${ENCRYPTION_KEY:-change-this-32-byte-key-here!!}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost}
      - LICENSE_SERVER_URL=${LICENSE_SERVER_URL:-https://ow-license1.byteforce.us/v1}
      - LICENSE_KEY=${LICENSE_KEY:-}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    command: celery -A app.tasks.celery_app beat --loglevel=info --schedule=/tmp/celerybeat-schedule

  frontend:
    image: ghcr.io/${GITHUB_OWNER:-gabegon8910}/server-management-frontend:${VERSION:-latest}
    container_name: ssm-frontend
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
    depends_on:
      - backend

  # Guacamole â€” browser-based RDP/SSH access
  guacamole-init-sql:
    image: guacamole/guacamole:latest
    container_name: ssm-guacamole-init-sql
    user: root
    entrypoint: /bin/sh
    command:
      - -c
      - |
        /opt/guacamole/bin/initdb.sh --postgresql > /docker-entrypoint-initdb.d/001-guacamole.sql
        chmod 644 /docker-entrypoint-initdb.d/001-guacamole.sql
        echo "Guacamole SQL schema generated"
    volumes:
      - guacamole_initdb:/docker-entrypoint-initdb.d
    restart: "no"

  guacamole-db-init:
    image: postgres:15-alpine
    container_name: ssm-guacamole-db-init
    entrypoint: /bin/sh
    environment:
      - PGPASSWORD=${POSTGRES_PASSWORD:-ssm_password}
    command:
      - -c
      - |
        echo "Waiting for SQL file..."
        while [ ! -f /initdb/001-guacamole.sql ]; do sleep 1; done
        echo "Checking if Guacamole schema exists..."
        if ! psql -h postgres -U ${POSTGRES_USER:-ssm_user} -d ${POSTGRES_DB:-ssm_db} -c "SELECT 1 FROM guacamole_user LIMIT 1" 2>/dev/null; then
          echo "Initializing Guacamole database schema..."
          psql -h postgres -U ${POSTGRES_USER:-ssm_user} -d ${POSTGRES_DB:-ssm_db} -f /initdb/001-guacamole.sql
          echo "Guacamole database initialized"
        else
          echo "Guacamole schema already exists, skipping initialization"
        fi
    volumes:
      - guacamole_initdb:/initdb:ro
    depends_on:
      guacamole-init-sql:
        condition: service_completed_successfully
      postgres:
        condition: service_healthy
    restart: "no"

  guacd:
    image: guacamole/guacd:latest
    container_name: ssm-guacd
    restart: unless-stopped

  guacamole:
    image: guacamole/guacamole:latest
    container_name: ssm-guacamole
    restart: unless-stopped
    environment:
      - GUACD_HOSTNAME=guacd
      - GUACD_PORT=4822
      - POSTGRESQL_HOSTNAME=postgres
      - POSTGRESQL_PORT=5432
      - POSTGRESQL_DATABASE=${POSTGRES_DB:-ssm_db}
      - POSTGRESQL_USER=${POSTGRES_USER:-ssm_user}
      - POSTGRESQL_PASSWORD=${POSTGRES_PASSWORD:-ssm_password}
    depends_on:
      guacamole-db-init:
        condition: service_completed_successfully
      guacd:
        condition: service_started

volumes:
  postgres_data:
  redis_data:
  backend_backups:
  guacamole_initdb:
